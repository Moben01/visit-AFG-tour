{% extends 'tour/upcomming_tours/upcomming_tour_template.html'%}
{% load static %}


{% block main %}
     <div class="col-lg-9" style="padding-left: 25px;">
        {% if message %}
            <p class="text-success messages">{{ message }}</p>
            <script>
                setTimeout(function() {
                    $('.messages').fadeOut('slow');
                }, 9000);
            </script>
        {% endif %}

        {% if not show_form and pre_arrival %}
  <div class="alert alert-success d-flex align-items-center justify-content-between">
    <div>
      <strong>Pre-arrival submitted.</strong>
      — Visa status: <span class="badge bg-secondary">
        {{ pre_arrival.get_visa_status_display }}
      </span>
    </div>
    <a class="btn btn-outline-primary btn-sm"
       href="{% url 'tour:up_commoing_tours_more_info' booking.id %}?edit=1">
       Edit
    </a>
  </div>

    <div class="alert alert-success d-flex align-items-center justify-content-between">
    <div>
      <strong>Download Your Invitation Letter Here.</strong>
      — Visa status: <span class="badge bg-secondary">
        Your Invitation Letter is ready
      </span>
    </div>
    <a class="btn btn-outline-success btn-sm"
       href="{% url 'tour:up_commoing_tours_more_info' booking.id %}?edit=1">
       Download Invitation Letter
    </a>
  </div>

  {# Page stays otherwise blank per your requirement #}



{% else %}






        <form method="post" enctype="multipart/form-data">
         
            {% csrf_token %}

            {# visa_status first #}
            <div class="mb-3">
                
                <label class="form-label" for="{{ form.visa_status.id_for_label }}">
                    {{ form.visa_status.label }}{% if form.visa_status.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                {{ form.visa_status }}
                {% for error in form.visa_status.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
            </div>
                                 <div class="card shadow-none" id="visa_only_group">
                            <div class="card-header">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h5 class="fs-18">Your Afghanistan Visa</h5>
                                </div>

                            </div>
                            <div class="card-body pb-1">
                                

                                <div class="row">
                                    <div class="col-md-12">
                                     
                                        <div class="col-lg-12">
                                        <div class="d-flex align-items-center">
                                              {# ONLY visa_copy here #}
                                            <div class="mb-3">
                                                <label class="form-label" for="{{ form.visa_copy.id_for_label }}">
                                                    {{ form.visa_copy.label }}
                                                </label>
                                                {{ form.visa_copy }}
                                                {% for error in form.visa_copy.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                   
                                </div>
                            </div>
                        </div>


                        <div class="card shadow-none" id="other_fields_group">
                            <div class="card-header">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h5 class="fs-18">Visa Application Support</h5>
                                </div>
                            </div>
                          
                            <div class="card-body pb-1">
                                
                                {# All other fields except visa_status + visa_copy #}
                                <div >
                                    {% for field in form %}
                                        {% if field.name != 'visa_status' and field.name != 'visa_copy' %}
                                            <div class="mb-3 {% if field.field.widget.input_type == 'checkbox' %}form-check{% endif %}">
                                                {% if field.field.widget.input_type == 'checkbox' %}
                                                    {{ field }}
                                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                                        {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                                    </label>
                                                {% else %}
                                                    <label class="form-label" for="{{ field.id_for_label }}">
                                                        {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                                    </label>
                                                    {{ field }}
                                                {% endif %}
                                                {% for error in field.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                             
                        </div> 
                        <div class="d-flex align-items-center justify-content-center mt-4 mb-3">
                                <button type="reset" class="btn btn-light me-2">Back</button>
                                <button type="submit" class="btn btn-primary">Save</button>
                        </div>


        </form>

        <style>.hidden { display: none; }</style>

        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const visaStatus = document.getElementById("id_visa_status");
            const visaOnly = document.getElementById("visa_only_group");
            const others = document.getElementById("other_fields_group");

            if (!visaStatus || !visaOnly || !others) return;

            const otherInputs = others.querySelectorAll("input, select, textarea");
            const visaInputs = visaOnly.querySelectorAll("input, select, textarea");

            function setRequired(list, on) {
                list.forEach(el => {
                    if (!el.name) return;
                    // only relax when hiding; do not force-true on show (server enforces anyway)
                    if (!on) el.required = false;
                });
            }

            function toggle() {
                const val = visaStatus.value; // 'yes' or 'no'
                if (val === 'yes') {
                    // show only visa_copy
                    visaOnly.classList.remove('hidden');
                    others.classList.add('hidden');
                    setRequired(otherInputs, false);
                } else if (val === 'no') {
                    // show all except visa_copy
                    visaOnly.classList.add('hidden');
                    others.classList.remove('hidden');
                    setRequired(visaInputs, false);
                } else {
                    // default: hide both groups if no valid selection
                    visaOnly.classList.add('hidden');
                    others.classList.add('hidden');
                    setRequired(otherInputs, false);
                    setRequired(visaInputs, false);
                }
            }

            visaStatus.addEventListener('change', toggle);
            toggle(); // initial
        });
        </script>
                    
                </div>

 {% endif %}
{% endblock %}