{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- Breadcrumb -->
<div class="breadcrumb-bar breadcrumb-bg-02 text-center">
    <div class="container">
        <div class="row">
            <div class="col-md-12 col-12">
                <h2 class="breadcrumb-title mb-2">Tour Booking</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center mb-0">
                        <li class="breadcrumb-item"><a href="index.html"><i class="isax isax-home5"></i></a></li>
                        <li class="breadcrumb-item active" aria-current="page">Tour Booking</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<!-- /Breadcrumb -->

<!-- Page Wrapper -->
<div class="content content-two">
    <div class="container">
        <div class="row">


            <div class="row">

                <!-- Checkout -->
                <div class="col-lg-12">
                    <div class="card checkout-card">
                        <div class="card-header">
                            <h5>Secure Checkout</h5>
                        </div>
                        <div class="card-body">
                            <div>

                                <div class="checkout-details">
                                    <!-- Itinerary -->
                                    <div class="bg-light-200 card-bg-light position-relative mb-4">
                                        <!-- Custom icon in top-right with link -->
                                        <a href="" class="position-absolute top-0 end-0 p-3 text-decoration-none"
                                            title="Customize your itinerary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                                                viewBox="0 0 20 20" fill="currentColor" class="text-primary">
                                                <path
                                                    d="M18.33 3.57s.27-.8-.31-1.36c-.53-.52-1.22-.24-1.22-.24c-.61.3-5.76 3.47-7.67 5.57c-.86.96-2.06 3.79-1.09 4.82c.92.98 3.96-.17 4.79-1c2.06-2.06 5.21-7.17 5.5-7.79M1.4 17.65c2.37-1.56 1.46-3.41 3.23-4.64c.93-.65 2.22-.62 3.08.29c.63.67.8 2.57-.16 3.46c-1.57 1.45-4 1.55-6.15.89" />
                                            </svg>
                                        </a>

                                        <!-- Heading with helper text -->
                                        <h5 class="fs-18 mb-3">
                                            Itinerary
                                            <small class="text-muted d-block">If you want to customize your itinerary,
                                                click the icon on the top right.</small>
                                        </h5>
                                        <div class="card shadow-none mb-0">
                                            <div class="card-body p-3">
                                                <div class="stage-flow">
                                                    {% for i in get_interary %}
                                                    <div class="d-flex align-items-center flows-step">
                                                        <span class="flow-step">{{i.day_number}}</span>
                                                        <div class="flow-content">
                                                            <div
                                                                class="d-flex align-items-center justify-content-between mb-2">
                                                                <div>
                                                                    <h6 class="fw-medium mb-1">Day {{i.day_number}},
                                                                        {{i.title}}</h6>
                                                                    <p>{{i.date}}</p>
                                                                </div>
                                                                <span
                                                                    class="avatar avatar-lg avatar-rounded flex-shrink-0">
                                                                    <img src="{{ i.image.url }}" alt="Img">
                                                                </span>
                                                            </div>
                                                            <p>
                                                                {{i.description}}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                    <section class="section benifit-section bg-light-200">
                                        <div class="container">
                                            <div
                                                class="section-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
                                                <div>
                                                    <h5>
                                                        <p class="text-muted mb-3">
                                                            <i class="isax isax-setting-2 me-1"></i>
                                                            Customize your tour details: accommodation, transport, tickets, security guide & translator.
                                                        </p>
                                                    </h5>
                                                </div>
                                            </div>
                                            <div class="place-slider owl-carousel owl-loaded owl-drag">
                                                <form hx-post="{% url 'tour:tour_booking' slug=find_tour.slug %}"
                                                      hx-target="#total_price_container"
                                                      hx-swap="innerHTML">
                                                      
                                                    {% csrf_token %}
                                                    <div class="owl-stage-outer">
                                                        <div class="owl-stage"
                                                            style="transform: translate3d(-330px, 0px, 0px); transition: 2s; width: 1650px;">
                                                            {% for acc in accommodation %}
                                                            <div class="owl-item" style="width: 220px; margin-right: 16px;">
                                                                <div class="place-item mb-3 flex-fill">
                                                                    <div class="place-img">
                                                                        <div class="slide-images">
                                                                            <a href="#" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#accommodationModal"
                                                                            data-name="{{ acc.name }}"
                                                                            data-type="{{ acc.get_type_display }}"
                                                                            data-location="{{ acc.location }}"
                                                                            data-address="{{ acc.address }}"
                                                                            data-phone="{{ acc.phone }}"
                                                                            data-email="{{ acc.email }}"
                                                                            data-website="{{ acc.website }}"
                                                                            data-rating="{{ acc.rating }}"
                                                                            data-price="{{ acc.price_per_night }}"
                                                                            data-image="{{ acc.image.url }}"
                                                                            data-images="{% for img in acc.images.all %}{{ img.image.url }},{% endfor %}">
                                                                                <img src="{{ acc.image.url }}" class="img-fluid w-100 rounded" style="height: 160px; object-fit: cover;" alt="{{ acc.name }}">
                                                                            </a>
                                                                        </div>
                                                                    </div>
                                                                    <div class="place-content pt-2">
                                                                        <h6 class="mb-1 text-truncate" style="font-size: 15px;">
                                                                            <a href="#" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#accommodationModal"
                                                                            data-name="{{ acc.name }}"
                                                                            data-type="{{ acc.get_type_display }}"
                                                                            data-location="{{ acc.location }}"
                                                                            data-address="{{ acc.address }}"
                                                                            data-phone="{{ acc.phone }}"
                                                                            data-email="{{ acc.email }}"
                                                                            data-website="{{ acc.website }}"
                                                                            data-rating="{{ acc.rating }}"
                                                                            data-price="{{ acc.price_per_night }}"
                                                                            data-image="{{ acc.image.url }}"
                                                                            data-images="{% for img in acc.images.all %}{{ img.image.url }},{% endfor %}"
                                                                            ><span style="color: goldenrod;">{{ acc.name }}</span> | {{ acc.location }}</a>
                                                                        </h6>
                                                                        <div class="border-top pt-2 mb-2">
                                                                            <h6 class="d-flex align-items-center">
                                                                                Rating:
                                                                                {% if acc.rating == 1 %}
                                                                                    <i class="isax isax-star-1 text-warning ms-2 me-1"></i>
                                                                                {% elif acc.rating == 2 %}
                                                                                    <i class="isax isax-star-1 text-warning ms-2 me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                {% elif acc.rating == 3 %}
                                                                                    <i class="isax isax-star-1 text-warning ms-2 me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                {% elif acc.rating == 4 %}
                                                                                    <i class="isax isax-star-1 text-warning ms-2 me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                {% elif acc.rating == 5 %}
                                                                                    <i class="isax isax-star-1 text-warning ms-2 me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                    <i class="isax isax-star-1 text-warning me-1"></i>
                                                                                {% else %}
                                                                                    <span class="text-muted ms-2">No rating</span>
                                                                                {% endif %}
                                                                            </h6>
                                                                        </div>
                                                                        <div class="d-flex align-items-center justify-content-between border-top pt-2">
                                                                            <h6 class="text-primary text-nowrap me-2 mb-0" style="font-size: 15px;">
                                                                                {{ acc.price_per_night }} <span class="fs-12 fw-normal text-default">/ Night</span>
                                                                            </h6>
                                                                            <div class="form-check mb-0">
                                                                                <input class="form-check-input" type="radio" name="selected_accommodation" id="acc{{ acc.id }}" value="{{ acc.id }}"
                                                                                    {% if selected_accommodation and selected_accommodation.id == acc.id %}checked{% endif %}>
                                                                                <label class="form-check-label" for="acc{{ acc.id }}">
                                                                                    Select
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    <div class="owl-stage-outer">
                                                        <div class="owl-stage"
                                                            style="transform: translate3d(-330px, 0px, 0px); transition: 2s; width: 1650px;">
                                                            {% for trans in transport %}
                                                            <div class="owl-item" style="width: 220px; margin-right: 16px;">
                                                                <div class="place-item mb-3 flex-fill">
                                                                    <div class="place-img">
                                                                        <div class="slide-images">
                                                                            <a href="#" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#transportModal"
                                                                            data-type="{{ trans.get_type_display }}"
                                                                            data-company_name="{{ trans.company_name }}"
                                                                            data-description="{{ trans.description }}"
                                                                            data-vehicle_number="{{ trans.vehicle_number }}"
                                                                            data-seats_available="{{ trans.seats_available }}"
                                                                            data-departure_location="{{ trans.departure_location }}"
                                                                            data-arrival_location="{{ trans.arrival_location }}"
                                                                            data-departure_time="{{ trans.departure_time }}"
                                                                            data-arrival_time="{{ trans.arrival_time }}"
                                                                            data-price="{{ trans.price }}"
                                                                            data-image="{{ trans.image.url }}"
                                                                            data-images="{% for img in trans.images.all %}{{ img.image.url }},{% endfor %}">
                                                                                <img src="{{ trans.image.url }}" class="img-fluid w-100 rounded" style="height: 160px; object-fit: cover;" alt="{{ trans.name }}">
                                                                            </a>
                                                                        </div>
                                                                    </div>
                                                                    <div class="place-content pt-2">
                                                                        <h6 class="mb-1 text-truncate" style="font-size: 15px;">
                                                                            <a href="#" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#transportModal"
                                                                            data-type="{{ trans.get_type_display }}"
                                                                            data-company_name="{{ trans.company_name }}"
                                                                            data-description="{{ trans.description }}"
                                                                            data-vehicle_number="{{ trans.vehicle_number }}"
                                                                            data-seats_available="{{ trans.seats_available }}"
                                                                            data-departure_location="{{ trans.departure_location }}"
                                                                            data-arrival_location="{{ trans.arrival_location }}"
                                                                            data-departure_time="{{ trans.departure_time }}"
                                                                            data-arrival_time="{{ trans.arrival_time }}"
                                                                            data-price="{{ trans.price }}"
                                                                            data-image="{{ trans.image.url }}"
                                                                            data-images="{% for img in trans.images.all %}{{ img.image.url }},{% endfor %}">
                                                                            <span style="color: goldenrod;">{{ trans.get_type_display }}</span> | {{ trans.departure_location }}</a>
                                                                        </h6>
                                                                        <div class="border-top pt-2 mb-2">
                                                                            <h6 class="d-flex align-items-center">
                                                                                Company: 
                                                                                <span style="color: rgb(195, 135, 45);">{{ trans.company_name }}</span>
                                                                            </h6>
                                                                        </div>
                                                                        <div class="d-flex align-items-center justify-content-between border-top pt-2">
                                                                            <h6 class="text-primary text-nowrap me-2 mb-0" style="font-size: 15px;">
                                                                                {{ trans.price }} <span class="fs-12 fw-normal text-default">/ Night</span>
                                                                            </h6>
                                                                            <div class="form-check mb-0">
                                                                                <input class="form-check-input" type="radio" name="selected_accommodation" id="acc{{ trans.id }}" value="{{ trans.id }}"
                                                                                    {% if selected_accommodation and selected_accommodation.id == trans.id %}checked{% endif %}>
                                                                                <label class="form-check-label" for="acc{{ trans.id }}">
                                                                                    Select
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                
                                                    <button type="submit" class="btn btn-primary mt-3">Save Selected Accommodation</button>
                                                </form>
                                                
                                                <div class="owl-dots disabled"></div>
                                            </div>
                                        </div>
                                    </section>
                                    <!-- /Itinerary -->


                                </div>
                            </div>
                            <div id="total_price_container" class="d-flex align-items-center justify-content-end flex-wrap gap-2 mt-3">
                                {% include 'partials/tour/_total_price_button.html' with total_price=None %}
                            </div>
                            
                        </div>
                    </div>
                </div>
                <!-- /Checkout -->


            </div>
            <!-- /Review Order Details -->

        </div>
    </div>
    <!-- /Page Wrapper -->

    <div class="modal fade" id="accommodationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="accModalTitle">Accommodation Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row gy-4">
                <div class="col-md-5">
                  <img id="accModalMainImage" src="" class="img-fluid rounded w-100" alt="">
                </div>
                <div class="col-md-7">
                  <h5 id="accModalName"></h5>
                  <p><strong>Type:</strong> <span id="accModalType"></span></p>
                  <p><strong>Location:</strong> <span id="accModalLocation"></span></p>
                  <p><strong>Address:</strong> <span id="accModalAddress"></span></p>
                  <p><strong>Phone:</strong> <span id="accModalPhone"></span></p>
                  <p><strong>Email:</strong> <span id="accModalEmail"></span></p>
                  <p><strong>Website:</strong> <a href="#" id="accModalWebsite" target="_blank"></a></p>
                  <p><strong>Price / Night:</strong> $<span id="accModalPrice"></span></p>
                  <p><strong>Rating:</strong> <span id="accModalRatingStars"></span></p>
                </div>
                <div class="col-12">
                  <h6>Gallery</h6>
                  <div class="d-flex flex-wrap gap-2" id="accModalGallery"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      

      <script>
        document.getElementById('accommodationModal').addEventListener('show.bs.modal', function (event) {
            const trigger = event.relatedTarget;
        
            // Get data attributes
            const name = trigger.getAttribute('data-name');
            const type = trigger.getAttribute('data-type');
            const location = trigger.getAttribute('data-location');
            const address = trigger.getAttribute('data-address');
            const phone = trigger.getAttribute('data-phone');
            const email = trigger.getAttribute('data-email');
            const website = trigger.getAttribute('data-website');
            const price = trigger.getAttribute('data-price');
            const rating = parseFloat(trigger.getAttribute('data-rating') || '0');
            const mainImage = trigger.getAttribute('data-image');
            const imageList = trigger.getAttribute('data-images') || '';
        
            // Fill fields
            document.getElementById('accModalTitle').textContent = name;
            document.getElementById('accModalName').textContent = name;
            document.getElementById('accModalType').textContent = type;
            document.getElementById('accModalLocation').textContent = location;
            document.getElementById('accModalAddress').textContent = address;
            document.getElementById('accModalPhone').textContent = phone || 'N/A';
            document.getElementById('accModalEmail').textContent = email || 'N/A';
            document.getElementById('accModalWebsite').textContent = website || 'N/A';
            document.getElementById('accModalWebsite').href = website || '#';
            document.getElementById('accModalPrice').textContent = price;
        
            // Main image
            document.getElementById('accModalMainImage').src = mainImage;
        
            // Rating stars
            const starsContainer = document.getElementById('accModalRatingStars');
            starsContainer.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                star.className = 'isax isax-star-1 me-1';
                star.classList.add(i <= rating ? 'text-warning' : 'text-secondary');
                starsContainer.appendChild(star);
            }
        
            // Gallery images
            const gallery = document.getElementById('accModalGallery');
            gallery.innerHTML = '';
            imageList.split(',').forEach(url => {
                if (url.trim()) {
                    const img = document.createElement('img');
                    img.src = url.trim();
                    img.className = 'rounded';
                    img.style = 'width: 80px; height: 60px; object-fit: cover;';
                    gallery.appendChild(img);
                }
            });
        });
        </script>
        

    {% endblock %}